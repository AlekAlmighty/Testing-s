<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Breathe Green - Badges</title>
  <link rel="stylesheet" href="dashboard.css">
  <style>
    body { font-family: 'Baloo 2', system-ui, sans-serif; background:#f6fbf6; color:#163423; padding:20px; }
    .header { display:flex; align-items:center; justify-content:space-between; max-width:1100px; margin:0 auto 20px; }
    .header .logo { font-weight:700; font-size:20px; }
    .back-link { text-decoration:none; color:#0a6a2b; font-weight:600; }
    .container { max-width:1100px; margin:0 auto; }
    h1 { margin:8px 0 18px; }
    .badges-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:16px; }
    .badge { background:linear-gradient(180deg,#fff,#f1fff1); border-radius:12px; padding:18px; text-align:center; box-shadow:0 1px 4px rgba(0,0,0,0.06); transition:transform .18s ease, box-shadow .18s ease; }
    .badge .icon { font-size:34px; display:block; margin-bottom:8px; opacity:.25; filter:grayscale(40%); transition:all .3s ease; height:44px; width:44px; margin-left:auto; margin-right:auto; }
    .badge .icon svg { width:44px; height:44px; display:block; }
    .badge h4 { margin:6px 0 4px; font-size:14px; }
    .badge p { margin:0; font-size:12px; color:#3a6b4a; }
    .badge.earned { transform:translateY(-4px); box-shadow:0 6px 18px rgba(34,128,63,0.18); }
    .badge.earned .icon { opacity:1; filter:none; text-shadow:0 2px 8px rgba(39,174,96,0.55); }
    .claim-btn { margin-top:10px; display:inline-block; background:#27ae60; color:#fff; border:0; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700; font-size:13px; }
    .claim-btn[disabled] { opacity:.6; cursor:default; }
    .claimed-label { margin-top:10px; display:inline-block; background:linear-gradient(180deg,#eaf9ef,#e2f6e7); color:#12703a; padding:8px 10px; border-radius:8px; font-weight:700; font-size:13px; }
    .badge.claimed { box-shadow:0 8px 20px rgba(39,174,96,0.22); border:1px solid rgba(39,174,96,0.12); }
    .progress { margin:16px 0 26px; display:flex; gap:12px; align-items:center; }
    .progress .bar { flex:1; height:12px; background:#e9f6ec; border-radius:8px; overflow:hidden; }
    .progress .bar > i { display:block; height:100%; background:#27ae60; width:0%; transition:width .6s ease; }
    .level { min-width:120px; background:#fff; padding:10px 12px; border-radius:10px; box-shadow:0 1px 4px rgba(0,0,0,0.04); }
    .note { font-size:13px; color:#406b4b; margin-top:10px; }
    .legend { margin-top:14px; font-size:13px; color:#355c42; }
  </style>
</head>
<body>
 <header class="dashboard-header">
    <div class="header-container">
      <div class="logo">Breathe Green</div>
      <nav class="nav-links">
        <a href="dashboard.html">Home</a>
        <a href="help.html">Help</a>
        <a href="money.html">Money Saved</a>
        <a href="milestones.html">Milestones</a>
        <a href="environment.html">Environment</a>
        <a href="badges.html" class="active">Badges</a>
        <a href="stories.html">Stories</a>
        <button id="logout-btn" class="logout-btn">Logout</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1>Your Badges & Levels</h1>

    <div class="progress">
      <div class="level">Level: <strong id="user-level">0</strong></div>
      <div class="bar"><i id="level-bar"></i></div>
      <div class="level">Days: <strong id="days-count">0</strong></div>
    </div>

    <div class="badges-grid" id="badges-grid">
      <!-- Badges rendered here -->
    </div>

    <p class="note">Badges light up automatically when you reach the milestone days.</p>
    <p class="legend">Milestones: 5, 10, 15, 30, 60, 90, 180, 365 days</p>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyACafoJ0E-rJGv0Qz0F5C879ggI8CRSQ3A",
      authDomain: "breathe-green-7cc38.firebaseapp.com",
      projectId: "breathe-green-7cc38",
      storageBucket: "breathe-green-7cc38.firebasestorage.app",
      messagingSenderId: "219050855571",
      appId: "1:219050855571:web:5a418b7b9982baa806d166",
      measurementId: "G-4CZ35QJLJ1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Logout handler
    document.getElementById('logout-btn').addEventListener('click', async () => {
      try {
        await signOut(auth);
        window.location.href = '../../login.html';
      } catch (err) {
        console.error('Logout failed:', err);
      }
    });

    const thresholds = [5,10,15,30,60,90,180,365];
    const badgesMeta = thresholds.map((d,i)=>({
      id: 'badge-'+d,
      days: d,
      title: `${d} Days Smoke-Free`,
      desc: i===0? 'First milestone — excellent start!' : `Reached ${d} days smoke-free!`,
      svg: [
        `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#e9f9ee"/><path d="M8 12l2 2 4-4" stroke="#27ae60" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
        `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="6" fill="#e9f9ee"/><path d="M7 12c2-3 4-5 8-5" stroke="#27ae60" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
        `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#eaf9ef"/><path d="M9 12h6" stroke="#27ae60" stroke-width="1.6" stroke-linecap="round"/></svg>`,
        `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="6" width="20" height="12" rx="6" fill="#f6fff7"/><path d="M6 12h12" stroke="#27ae60" stroke-width="1.4" stroke-linecap="round"/></svg>`,
        `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l2.9 6.8L22 10l-5 4.2L18 22l-6-3.4L6 22l1-7.8L2 10l7.1-1.2L12 2z" fill="#eafbf0"/><path d="M12 2l2.9 6.8L22 10l-5 4.2L18 22l-6-3.4L6 22l1-7.8L2 10l7.1-1.2L12 2z" stroke="#27ae60" stroke-width="0.6"/></svg>`,
        `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#eefbf2"/><path d="M8 12c2 3 6 3 8 0" stroke="#27ae60" stroke-width="1.4" stroke-linecap="round"/></svg>`,
        `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="4" fill="#f3fff6"/><path d="M8 8l8 8" stroke="#27ae60" stroke-width="1.4" stroke-linecap="round"/></svg>`,
        `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l3 6 6 .5-4.5 4L19 22l-7-4-7 4 1.5-9.5L3 8.5 9 8 12 2z" fill="#f5fff8" stroke="#27ae60" stroke-width="0.6"/></svg>`
      ][i]
    }));

    const grid = document.getElementById('badges-grid');
    const daysCountEl = document.getElementById('days-count');
    const levelEl = document.getElementById('user-level');
    const levelBar = document.getElementById('level-bar');

    function renderBadges(days) {
      grid.innerHTML = '';
      badgesMeta.forEach(b => {
        const earned = days >= b.days;
        const claimed = (window.claimedBadges || []).includes(b.days);
        const el = document.createElement('div');
        el.className = 'badge' + (earned ? ' earned' : '') + (claimed ? ' claimed' : '');
        el.id = b.id;
        el.innerHTML = `
          <div class="icon">${b.svg}</div>
          <h4>${b.title}</h4>
          <p>${b.desc}</p>
          ${earned ? (claimed ? '<div class="claimed-label">✓ Claimed</div>' : `<button class="claim-btn" data-days="${b.days}">Claim Reward</button>`) : ''}
        `;
        grid.appendChild(el);
      });
    }

    function computeLevelFromClaims() {
      const claimed = Array.isArray(window.claimedBadges) ? window.claimedBadges.length : 0;
      return claimed;
    }

    function updateUI(days) {
      window.currentDays = Number(days) || 0;
      daysCountEl.textContent = window.currentDays;

      const lvl = computeLevelFromClaims();
      levelEl.textContent = lvl;

      const claimedCount = lvl;
      const pct = Math.min(100, Math.round((claimedCount / badgesMeta.length) * 100));
      levelBar.style.width = pct + '%';

      renderBadges(window.currentDays);
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = '../../login.html';
        return;
      }

      window.currentUser = user;

      try {
        const udocRef = doc(db, 'users', user.uid);
        const udoc = await getDoc(udocRef);
        let days = 0;
        window.claimedBadges = [];
        if (udoc.exists()) {
          const data = udoc.data();
          if (data.quitDate) {
            const q = new Date(data.quitDate);
            q.setHours(0,0,0,0);
            const today = new Date(); today.setHours(0,0,0,0);
            days = Math.max(0, Math.floor((today - q) / (1000*60*60*24)));
          }
          if (Array.isArray(data.badgesClaimed)) window.claimedBadges = data.badgesClaimed.map(x => parseInt(x,10));
        }
        updateUI(days);
      } catch (err) {
        console.warn('Failed to load user profile for badges', err);
        const fallback = parseInt(localStorage.getItem('debugDays') || '0', 10) || 0;
        window.claimedBadges = JSON.parse(localStorage.getItem('claimedBadges') || '[]');
        updateUI(fallback);
      }
    });

    const obs = new MutationObserver((list) => {
      for (const m of list) {
        for (const node of m.addedNodes) {
          if (node.nodeType === 1 && node.classList.contains('badge') && node.classList.contains('earned')) {
            node.animate([
              { transform: 'scale(0.92)', opacity: 0 },
              { transform: 'scale(1.06)', opacity: 1 },
              { transform: 'scale(1)', opacity: 1 }
            ], { duration: 700, easing: 'cubic-bezier(.22,1,.36,1)' });
          }
        }
      }
    });
    obs.observe(grid, { childList:true, subtree:true });

    document.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('.claim-btn');
      if (!btn) return;
      const days = parseInt(btn.dataset.days, 10);
      if (isNaN(days)) return;
      btn.disabled = true;
      btn.textContent = 'Claiming...';

      const markClaimedLocally = () => {
        window.claimedBadges = Array.from(new Set([...(window.claimedBadges||[]), days]));
        localStorage.setItem('claimedBadges', JSON.stringify(window.claimedBadges));
        updateUI(window.currentDays || 0);
      };

      try {
        if (window.currentUser) {
          await updateDoc(doc(db, 'users', window.currentUser.uid), { badgesClaimed: arrayUnion(days) });
          markClaimedLocally();
        } else {
          markClaimedLocally();
        }
      } catch (err) {
        console.warn('Failed to persist claimed badge, falling back to localStorage', err);
        markClaimedLocally();
      }
    });
  </script>
</body>
</html>
